#
# Using Conda within ENTRYPOINT was taken from:
# https://pythonspeed.com/articles/activate-conda-dockerfile/
#
# This Dockerfile will create a base image containing all the Conda and Pip
# requirements for the variable subsetter. It also sets the environment
# variables necessary to mimic a `conda activate` command.
#
# This Dockerfile does not copy the pymods or the test directory, these will
# be copied when the image is run as a container, to allow more rapid
# development iteration.
#

FROM continuumio/miniconda3

WORKDIR "/home"

# Bundle app source
COPY conda_requirements.txt .
COPY pip_requirements.txt .
COPY tests/pip_test_requirements.txt .

# Create Conda environment
RUN conda create --name subsetter --file conda_requirements.txt python=3.7 \
	--channel conda-forge \
	--channel defaults

# Install additional Pip dependencies
RUN conda run --name subsetter pip install -r pip_requirements.txt

# Install additional Pip requirements (for testing)
RUN conda run --name subsetter pip install -r pip_test_requirements.txt

# Set conda environment to subsetter, as conda run will not stream logging.
# Setting these environment variables is the equivalent of `conda activate`.
ENV _CE_CONDA ''
ENV _CE_M ''
ENV CONDA_DEFAULT_ENV subsetter
ENV CONDA_EXE /opt/conda/bin/conda
ENV CONDA_PREFIX /opt/conda/envs/subsetter
ENV CONDA_PREFIX_1 /opt/conda
ENV CONDA_PROMPT_MODIFIER (subsetter)
ENV CONDA_PYTHON_EXE /opt/conda/bin/python
ENV CONDA_ROOT /opt/conda
ENV CONDA_SHLVL 2
ENV PATH "/opt/conda/envs/subsetter/bin:${PATH}"
ENV SHLVL 1
